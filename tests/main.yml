---
# Tasks for testing role

- name: Setup testing sandbox
  hosts: localhost
  roles:
    - role: amtega.docker_presets
      vars:
        docker_presets_images_json_query: >-
          [? starts_with(name, `centos-7`)
             || starts_with(name, `fedora-29`)
             || starts_with(name, `fedora-30`) ]

    - role: amtega.docker_sandbox
      vars:
        docker_sandbox_state: started
        docker_sandbox_idempotence_test: no
  tags:
    - sandbox

- name: Test git_commit role
  hosts: docker_sandbox_containers
  roles:
    - role: amtega.git_clone
      vars:
        git_clone_repo: https://github.com/amtega/ansible_role_ansible.git
        git_clone_dest: /tmp/git_commit
  tasks:
    - name: Create testing file
      copy:
        content: Hello World
        dest: /tmp/git_commit/testing_file

    - name: Configure git for testing
      git_config:
        scope: global
        name: "{{ item.name }}"
        value: "{{ item.value }}"
      loop:
        - name: user.email
          value: user@acme.com
        - name: user.name
          value: Testing user
      loop_control:
        label: "{{ item.name }}"

    - include_role:
        name: amtega.git_commit
      vars:
        git_commit_repo_dir: /tmp/git_commit
        git_commit_message: Ansible git_commit role test.
        git_commit_add_changes: yes

- name: Cleanup testing sandbox
  hosts: localhost
  roles:
    - role: amtega.docker_sandbox
      vars:
        docker_sandbox_state: absent
  tags:
    - cleanup
    - sandbox
